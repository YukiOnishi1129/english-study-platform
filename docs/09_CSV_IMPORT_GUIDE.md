# CSV インポート仕様

教材・章・UNIT・問題をまとめて登録するための CSV 形式と、管理画面での取り扱い手順を整理しました。CSV は UTF-8（BOM なし推奨）で保存してください。

---

## 1. カラム定義

| 列名        | 必須 | 内容                                                                 |
|-------------|------|----------------------------------------------------------------------|
| 教材名      | ✅   | 教材のタイトル。行ごとに同じ教材名なら同一教材として扱われます。         |
| 章名        | ✅   | 章パス。階層を持つ場合は `第1章/定型フレーズ編/基本挨拶` のように `/` で連結します。 |
| UNIT名      | ✅   | UNIT のタイトル。章内で同名なら同一 UNIT としてマージされます。           |
| 日本語      | ✅   | 問題文（日本語）。                                                    |
| 英語正解1   | ✅   | 正解文のメイン回答。                                                  |
| 英語正解2〜 | 任意 | `英語正解2`, `英語正解3`, ... と連番で追加可能。何列でも指定できます。 |
| ヒント      | 任意 | 問題に対する補助ヒント。                                              |
| 解説        | 任意 | 問題の解説や補足。                                                    |

> **メモ**  
> 列名は半角スペース無しで記述してください（例: `英語正解1`）。追加列があっても読み込み可能ですが、上記以外の列は無視されます。

---

## 2. サンプル CSV

| 教材名       | 章名（パス表記）                                     | UNIT名        | 日本語         | 英語正解1      | 英語正解2           | 英語正解3     | ヒント                          | 解説                                      |
|--------------|------------------------------------------------------|---------------|----------------|----------------|---------------------|---------------|----------------------------------|-------------------------------------------|
| 基礎英会話     | 第1章 あいさつ                                         | Unit1 朝の挨拶 | おはようございます | Good morning   | Morning!            |               | 時間帯に応じた挨拶を使い分けましょう | フォーマルな場面では Good morning を使います |
| 基礎英会話     | 第1章 あいさつ                                         | Unit2 昼の挨拶 | こんにちは         | Good afternoon | Hi there            |               |                                  |                                           |
| ビジネス英会話   | 第1章 ミーティング/第1節 会議準備                         | Unit1 会議開始 | 会議を始めましょう | Let's begin the meeting. | Shall we start the meeting? |               |                                  |                                           |
| ビジネス英会話   | 第1章 ミーティング/第2節 議題確認                         | Unit2 議題確認 | 次の議題に移ります | Let's move to the next agenda. | Let's proceed to the next topic. |         |                                  |                                           |
| 基礎英会話     | 第2章 自己紹介/第1節 基本自己紹介/第1項 名前の紹介           | Unit3 自己紹介 | 私は田中です       | I'm Tanaka.    | My name is Tanaka. | Tanaka here. | 名前の前に I'm を付けるのが自然      | 状況によって My name is... も使えます        |

### どう階層化されるか

- **教材名** → 教材単位でまとめる（例: 「基礎英会話」）
- **章名** → 教材内で章をグループ化
- **UNIT名** → 各章にぶら下がる UNIT を構成
- 1 行ごとに 1 問（日本語・正解群・ヒント・解説）

> **正解の列について**
> `英語正解1` は必須です。それ以外の正解は `英語正解2`, `英語正解3`, ... のように連番で好きなだけ追加できます。

同じ教材/章/UNIT の行が連続していなくても問題ありません。インポート時に自動でマージされます。

---

## 3. 管理画面での流れ

1. `/materials/import`（管理者ログイン後）にアクセス
2. 「CSVファイルを選択」から CSV をアップロード
3. プレビューで以下を確認
   - 新規作成される教材・章・UNIT の数
   - 教材 → 章 → UNIT の階層構造
   - 行ごとの明細（日本語、正解、ヒント、解説）
4. 問題がなければ今後実装予定の「取り込み」アクションで DB へ登録（現在はプレビューまで）

---

## 4. よくある質問

- **Q. 列の順番は変えても良い？**  
  A. 列名で判定するため順序は自由です。ただし必須列を省略しないでください。

- **Q. ダブルクォートを含むテキストは？**  
  A. RFC4180 形式で `"\"he said\""` のようにエスケープしてください。インポート側で正しくパースします。

- **Q. 空行はどう扱われる？**  
  A. 完全に空の行は読み飛ばされます。必須列が欠けている行はエラーとして表示されます。

- **Q. 既存データとの突き合わせは？**  
  A. 現時点では名前一致によるマージのみ。将来的には ID 連携や差分更新の検討中です。

---

## 5. 今後の拡張について

- CSV プレビュー後に「DBへ送信」ボタンと、差分確認 UI を追加予定
- 章の階層が 3 階層以上に増える場合は列を増やす案を検討中
- 取り込み失敗時のロールバック・通知機構を現在設計中

仕様が更新された場合、本ドキュメントを最新版としてメンテナンスします。
