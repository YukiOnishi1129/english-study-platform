# UNIT CSV インポート仕様

UNIT 詳細ページ（例: `/materials/{materialId}/chapters/{chapterId}/units/{unitId}`）で利用できる「CSV で問題を取り込む」機能の仕様をまとめています。CSV のエンコードは UTF-8（BOM なし推奨）で保存してください。

---

## 1. カラム定義（フレーズ教材）

| 列名           | 必須 | 内容                                                                                                                    |
|----------------|------|-------------------------------------------------------------------------------------------------------------------------|
| 関連ID         | 任意 | 既存問題を更新する場合に指定。空欄の場合は新規問題として扱われます。`問題ID` という列名でも読み込めます。          |
| 並び順         | 任意 | 数値で指定。空欄の場合は既存順序を維持。新規の場合は末尾に追加されます（CSV 解析後、UI 上で並び順を確認できます）。 |
| 日本語         | ✅   | 問題文（日本語）。                                                                                                      |
| ヒント         | 任意 | 問題に対する補助ヒント。                                                                                                |
| 解説           | 任意 | 問題の解説や補足。                                                                                                      |
| 英語正解1      | ✅   | 正解文のメイン回答。                                                                                                    |
| 英語正解2〜    | 任意 | `英語正解2`, `英語正解3`, … と連番で追加可能。空欄は無視されます。                                                    |

> **メモ**  
> 列名は半角スペース無しで記述してください（例: `英語正解1`）。必要に応じて `英語正解3`, `英語正解4`… を追加できます。

---

## 1.2 カラム定義（語彙教材）

語彙教材用テンプレートでは語彙メタ情報と出題設定を同時に取り込みます。

| 列名                 | 必須 | 内容 |
|----------------------|------|------|
| 語彙ID               | 任意 | 既存の語彙エントリを更新する場合に指定。空欄は新規エントリ。 |
| 問題ID               | 任意 | 該当語彙に紐づく既存問題を更新する場合に指定。`関連ID` 列としても読み込み可能。 |
| 並び順               | 任意 | UNIT内での表示順。空欄は末尾。 |
| 英単語               | ✅   | 見出し語。VocabularyEntry.headword に対応。 |
| 日本語訳1            | ✅   | 主要な訳語（definition_ja）。回答判定にも利用。 |
| 日本語訳2〜          | 任意 | 追加の訳語。プレビューおよび許容解答として利用。 |
| 品詞                 | 任意 | `noun`, `verb`, `adj.` など。 |
| 発音                 | 任意 | 読み方やIPA表記。 |
| プロンプト           | 任意 | 追加説明や指示文（例: 「この単語を使って英文を作成」）。 |
| 正解候補1            | ✅   | Questionに登録する正解。学習モードに応じた言語で記述。 |
| 正解候補2〜          | 任意 | 追加の正解。CorrectAnswerとして登録。 |
| 類義語1〜            | 任意 | `VocabularyRelation (synonym)` として登録。 |
| 対義語1〜            | 任意 | `VocabularyRelation (antonym)` として登録。 |
| 関連語1〜            | 任意 | `VocabularyRelation (related)` として登録。 |
| 例文(英)             | 任意 | 英語の例文。free_sentence/clozeモードで表示。 |
| 例文(和)             | 任意 | 例文の日本語訳。 |

> **補足**  
> 列名の末尾に数字を付けることで任意個追加できます（例: `正解候補3`、`類義語4`）。空欄は無視されます。

---

## 2. サンプル CSV

| 関連ID | 並び順 | 日本語               | ヒント                    | 解説                                  | 英語正解1             | 英語正解2           |
|--------|--------|----------------------|---------------------------|---------------------------------------|-----------------------|---------------------|
|        | 1      | 朝の挨拶をしましょう | 朝は Good morning が定番 | フォーマルな場面でも Good morning を使う | Good morning.         | Morning!            |
| q-1234 | 2      | こんにちはと伝える   | Hi はカジュアル           | 既存問題を上書き（関連ID 指定）       | Hello.                | Hi.                 |
|        |        | 誰かに会えて嬉しいと伝える |                           |                                       | Nice to see you.      | Great to see you!   |

- 1 行につき 1 問を表します。
- `関連ID` が空欄の行は新規問題になります。
- `関連ID` を入力した行は、該当 ID の問題を上書きする前提で解析されます。ID 不一致の場合はエラーとして表示されます。
- `英語正解` 列は `英語正解1`, `英語正解2`, … と連番で必要なだけ追加してください。空欄は無視されます。

---

### 2.1 語彙教材用サンプル

| 語彙ID | 問題ID | 並び順 | 英単語 | 日本語訳1 | 日本語訳2 | 品詞 | プロンプト                     | 正解候補1 | 正解候補2 | 類義語1 | 対義語1 | 関連語1 | 例文(英)                               | 例文(和)                         |
|--------|--------|--------|--------|-----------|-----------|------|--------------------------------|-----------|-----------|---------|---------|---------|----------------------------------------|----------------------------------|
|        |        | 1      | accept | 受け入れる | 受諾する  | verb |                                | accept    | accept it | receive | refuse  | admit   | We must accept the offer immediately. | 我々はその提案をすぐに受け入れる必要がある。 |
| vocab-1|        | 2      | cheerful | 陽気な   | 快活な    | adj. |                                | cheerful | bright    | joyful  | gloomy  | upbeat  | Her cheerful voice brightened the room. | 彼女の陽気な声が部屋を明るくした。        |
| vocab-2| q-888  | 3      | contribute | 貢献する | 寄与する | verb | この単語を1文で使ってください | contribute |          | donate  | withhold| support | She contributes to the community weekly. | 彼女は毎週地域社会に貢献している。        |

- 語彙エントリと問題設定をまとめて1行に記述します。
- 学習モードはCSVで指定せず、学習セッション開始時にUIから「JP→EN」「EN→JP」「例文」などを切り替える想定です。
- 類義語／対義語／関連語はVocabularyRelationとして保存され、学習画面のフィードバックに表示されます。

---

## 3. 管理画面での手順（UNIT詳細ページ）

1. 対象 UNIT の詳細ページにアクセス  
   例: `/materials/{materialId}/chapters/{chapterId}/units/{unitId}`
2. 「CSVで問題を取り込む」セクション内の「CSVファイルを選択」をクリック
3. CSV を選択すると即座にブラウザで解析され、以下の情報がプレビューされます
   - CSV 内の行数
   - 新規追加と更新の見込み数
   - 行ごとの明細（語彙ID・問題ID、日本語/英語、正解群、語彙メタ情報、ヒント/解説、並び順）
4. 内容を確認したら「取り込みを実行」をクリックすると DB に反映されます  
   （関連IDが一致する行は上書き、空欄の行は新規問題として追加されます）。

---

## 4. エラーハンドリング

CSV 解析時に以下のチェックを行い、問題があればプレビューエリアにエラーメッセージを表示します。

- 必須列（日本語・英語正解1）が空欄
- `並び順` に数値以外が入力されている
- `関連ID` が指定されているが既存データに該当がない（将来の取り込み時に検証予定）
- 語彙教材の場合、`英単語` または `正解候補1` が空欄
- 行内がすべて空欄 → スキップ（エラーではありません）

---

## 5. 今後の拡張予定

- CSV 取り込みと既存問題の差分確認 UI の提供
- 取り込み時のバリデーション強化（関連ID / 語彙ID の存在確認、並び順の自動整列など）
- free_sentence モードでの自動採点（LLM評価、キーワード判定）の導入

仕様が更新された場合、本ドキュメントを新版としてメンテナンスします。


## 6. 個別編集との併用

- 問題を個別に確認・修正する場合は `/questions/[questionId]` から詳細ページを開きます。
- 詳細ページには「編集」「削除」アクションが用意されており、変更後は UNIT/章/教材一覧に自動反映されます。
- CSVで一括更新後、プレビューから対象の問題へ遷移して内容を確認する運用も想定しています。
- 語彙教材では `/vocabulary/[entryId]`（想定ルート）から類義語・対義語などの単語情報を個別編集できるようにする計画です。
