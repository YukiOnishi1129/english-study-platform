# 英会話学習システム 要件定義

## 1. システム概要

英会話フレーズの学習を効率化するWebアプリケーション。Excel管理の課題を解決します。

**解決する課題:**
- データ消失リスクの排除
- ランダム出題機能の実現
- 学習履歴の記録と分析
- 音声再生の簡便化

## 2. 技術スタック

- **フレームワーク**: Next.js (App Router)
- **ORM**: Drizzle ORM
- **認証**: next-auth v4 + Google Identity Platform
- **データベース**:
    - 本番環境: Neon (PostgreSQL)
    - ローカル環境: Docker Compose でPostgreSQLコンテナを起動
- **設計方針**: https://zenn.dev/yukionishi/articles/cd79e39ea6c172 に準拠

## 3. 認証機能

### 3.1 認証方式

- Google認証のみ（next-auth v4）
- ユーザー情報はDBに記録
- account情報をuseSessionで取得できるよう型定義をカスタマイズ

### 3.2 セッション管理

- ログイン状態の判定: next-authのsession情報の有無
- Identity Platformでの認証管理
- idToken/refreshTokenが無効な場合は401エラーで強制ログアウト

### 3.3 権限管理

- **roleカラムをaccountテーブルに追加**
- role = "admin" のユーザーのみ管理画面にアクセス可能
- 一般ユーザーは学習機能のみ利用可能

## 4. データ構造

### 4.1 教材の階層構造

```
教材（例: 英会話フレーズ）
└── 章（例: 第1章 定型フレーズ編、第2章 文法活用編）
    └── UNIT（例: UNIT1 1語フレーズ、UNIT7 挨拶）
        └── 問題（複数問）
```

**特徴:**
- 教材ごとに柔軟な階層構造を設定可能
- 管理画面から階層を自由に作成・編集

### 4.2 問題データ

| 項目 | 説明 |
|------|------|
| **日本語文** | 出題文 |
| **英語正解** | 複数の正解パターンを登録可能 |
| **ヒント** | 任意で表示可能 |
| **解説** | 文法解説、よくある間違いなど |
| **音声** | 正解の英文を音声で再生（Google TTS等） |
| **語彙メタ情報** | 語彙教材の場合のみ：品詞、類義語、対義語などを表示用に保持 |

## 5. 主要機能

### 5.1 ダッシュボード

#### 学習統計の表示
- 累計解答数
- 今日の学習問数
- 全体の正答率
- 学習履歴（日付別の解答数）

#### 教材選択UI
- 教材 → 章 → UNIT の階層で選択
- 各UNITの問題数を表示

#### よくある間違い一覧
- 全体または問題ごとの間違いパターン分析

### 5.2 学習機能（1問1答）

#### 問題表示
- 日本語文を表示
- ヒントボタンでヒント表示
- 進捗表示（現在X問目/全Y問）

#### 解答入力
- テキスト入力で英語を記述
- Enterキーで送信可能

#### 判定ロジック
- 一字一句正確に一致すれば正解
- 複数の正解パターンのいずれかに一致すればOK
- 不一致なら不正解

#### 判定後の操作
- 正解/不正解の表示
- 正解の英文表示（複数あれば全て）
- 音声再生ボタン（Google TTS等）
- **手動修正機能**: 明らかに正解なのに不正解と判定された場合、「正解にする」ボタンで修正可能
- 解説文の表示
- 次の問題へ進むボタン

#### ランダム出題機能
- 選択したUNIT内でランダム順に出題

### 5.2.1 語彙学習モード

語彙専用教材（Vocabulary Material）では以下の学習モードを追加で提供する。

- **認知モード（Reading）**: 英単語を提示し、日本語訳（選択式または記述式）を入力
- **再生モード（Writing）**: 日本語訳を提示し、英単語のスペルを入力
- **例文モード**
  - 単語挿入（Cloze）: 定型文の空欄に単語を入力
  - フリー英作文: 指定単語を含む英文を作成し、必須語を含んでいるか・モデル解と一致するかで判定
- **切替設定**: 単語ごと、UNITごとに許容する学習モードを設定可能（例: 単語のみ回答／例文も必須）
- **表示情報**: 品詞、アクセント、類義語／対義語／関連語を回答後のフィードバックで表示

### 5.3 記録機能

#### 問題ごとに記録
- 正答率
- 過去の解答回数
- 自分が書いた解答の履歴
- 解答日時

#### 間違い分析
- よくある間違いパターンの抽出
- 問題ごとの間違いパターン表示
- ダッシュボードで全体の傾向表示

### 5.4 履歴表示

#### 問題ごとの履歴
- 解答ボタン押下後に「過去の解答を見る」ボタン
- その問題でこれまでに書いた解答一覧
- 正解/不正解の履歴

#### 学習履歴
- カレンダービューで何日に何問解いたか
- 日別/週別/月別の統計

## 6. 管理機能（admin権限のみアクセス可能）

### 6.1 権限チェック

- accountテーブルのroleカラムを確認
- role = "admin" 以外はアクセス拒否（403エラー）

### 6.2 教材管理

- 教材の追加/編集/削除
- 階層構造の作成/編集
  - 章の追加/編集/削除
  - UNITの追加/編集/削除

### 6.3 問題管理

- 問題の追加/編集/削除
- 複数正解の登録
- ヒント・解説の編集

### 6.4 CSV一括インポート機能

#### 処理フロー

1. **CSVファイルアップロード**
   - ブラウザ上でCSVファイルを選択・アップロード
   - Next.jsのブラウザ環境で処理（サーバーサイドでも可）

2. **プレビュー画面**
   - アップロードしたCSVの内容を解析
   - データ構造の確認表示
   - 階層構造のマッピング確認

3. **確認・取り込み**
   - ユーザーが「OK」をクリック
   - トランザクション処理でDBに一括登録
   - エラーがあればロールバックして通知

#### CSVフォーマット

| カラム名 | 説明 |
|----------|------|
| 教材名 | 所属する教材の名前 |
| 章名 | 章の名前 |
| UNIT名 | UNITの名前 |
| 日本語 | 問題文（日本語） |
| 英語正解1 | メインの正解文 |
| 英語正解2 | 別解1（任意） |
| 英語正解3 | 別解2（任意） |
| ヒント | ヒント文（任意） |
| 解説 | 解説文（任意） |
| 語彙情報 | 語彙教材の場合のみ：英単語、品詞、類義語、対義語、例文など（詳細は「UNIT CSV インポート仕様」を参照） |

## 7. 開発環境・インフラ

### 7.1 データベース環境

| 環境 | データベース | 備考 |
|------|------------|------|
| **本番環境** | Neon | Serverless PostgreSQL |
| **ローカル環境** | Docker Compose | PostgreSQLコンテナ、docker-compose.ymlで管理 |

### 7.2 環境変数

DATABASE_URLを環境ごとに切り替え:
- **本番**: Neonの接続文字列
- **ローカル**: Docker PostgreSQLの接続文字列

## 8. UI/UX要件

- PCでの利用を主目的とする
- スマホでも利用可能（レスポンシブ）
- 音声再生はワンクリックで実行
- データ消失のリスクがない安全な環境

## 9. 今後の拡張可能性

- 他の言語学習への対応
- 音声入力での解答
- AIによる解答評価（類似表現の許容）
- スペースドリピティション（間隔反復）機能
- 弱点問題の自動抽出・集中学習
